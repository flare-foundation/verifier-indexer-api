stages:
  - build
  - test
  - report

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH

variables:
  NODE_VERSION: "24.12.0"

include:
  - component: gitlab.com/flarenetwork/ci-components-private/ai-code-review@1
    inputs:
      use_cursor_cli: true
      rules_condition: $CI_MERGE_REQUEST_IID != null && $GITLAB_USER_NAME != "SealBot" && $CI_MERGE_REQUEST_EVENT_TYPE != "merge_train"
      rules_when: always
  - component: gitlab.com/flarenetwork/ci-components-private/release-image@1
    inputs:
      job_name_suffix: "-gitlab-cr"
      image_name: "verifier-indexer-api"
      image_tag_source: "commit_hash"
      build_tags: ["flarenetwork-md"]
      stage: build
      push_to_staging: true
      push_to_production_on_protected: false
      staging_registry: "registry.gitlab.com/flarenetwork/fdc"
      rules_condition: $CI_MERGE_REQUEST_IID != null

build-app:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - yarn install --frozen-lockfile
  script:
    - yarn build
  artifacts:
    paths:
      - dist/

e2e_test:
  stage: test
  image: node:${NODE_VERSION}
  variables:
    POSTGRES_DB: db
    POSTGRES_USER: user
    POSTGRES_PASSWORD: pass
    PGPASSWORD: ${POSTGRES_PASSWORD}
  services:
    - name: postgres:17
      alias: postgres
  before_script:
    - yarn install --frozen-lockfile
    - apt update && apt install -y postgresql-common
    - YES=1 /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh
    - apt -y install postgresql-client-17
    - mkdir -p test/e2e_tests/db
    - |
      set -euo pipefail

      fetch_and_verify() {
        URL="$1"
        OUT="$2"
        EXPECTED_SHA256="$3"

        echo "Processing $OUT"

        ACTUAL="$(curl -fSL "$URL" | tee "$OUT" | sha256sum | awk '{print $1}')" || {
          echo "Download failed for $URL"; rm -f "$OUT"; exit 2
        }
        if [ "$ACTUAL" != "$EXPECTED_SHA256" ]; then
          echo "Checksum mismatch for $OUT: expected $EXPECTED_SHA256 got $ACTUAL"
          rm -f "$OUT"
          exit 2
        fi

        echo "Verified $OUT"
      }

      fetch_and_verify https://githubstatic.flare.center/db_btc_testnet test/e2e_tests/db/db_btc_testnet "29f0845af2ffc894721849fdbb4eb648c62545632221cf3b5bc2642b8ab29a9a"
      fetch_and_verify https://githubstatic.flare.center/db_btc2_testnet test/e2e_tests/db/db_btc2_testnet "9bf89c182b6e9b286a5dd9e491f12c33be5052cd5110f9fc6c7bc3bf81f46158"
      fetch_and_verify https://githubstatic.flare.center/db_doge_testnet test/e2e_tests/db/db_doge_testnet "af6cad36228747927a013db2d596fe57948a24586c737445c7bde420331cc86e"
      fetch_and_verify https://githubstatic.flare.center/db_xrp_testnet test/e2e_tests/db/db_xrp_testnet "db1ef0794bff297323db63f783d030a9af66c5ac8318441c03c9fea2fa792e35"
      fetch_and_verify https://githubstatic.flare.center/db_xrp2_testnet test/e2e_tests/db/db_xrp2_testnet "72277e725b9ff5a5f679c56d163724a0206ebdbe4f89f333a42b1d26efab9652"
  script:
    - yarn test ci

lint:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - yarn install --frozen-lockfile
  script:
    - yarn lint:check
    - yarn format:check
